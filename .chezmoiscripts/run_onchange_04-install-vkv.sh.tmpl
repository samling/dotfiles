#!/usr/bin/env bash

{{- $osID := .system.os_type }}
{{- $hostname := .chezmoi.fqdnHostname -}}
{{- $hostData := index .host $hostname -}}
{{- $enabledGroups := list -}}

{{- /* Get enabled package groups for this host */}}
{{- if and $hostData (hasKey $hostData "packageGroups") (hasKey $hostData.packageGroups "enabled") -}}
  {{- $enabledGroups = $hostData.packageGroups.enabled -}}
{{- end -}}

{{- if has "cloud" $enabledGroups }}
echo "Installing vkv for {{ $osID }}..."

# Check if go is installed
if ! command -v go &> /dev/null; then
    echo "Go is required to install vkv. Please install go first."
    exit 1
fi

{{- if eq $osID "darwin" }}
# On macOS, use Homebrew if available
if command -v brew &> /dev/null; then
    brew install falcosuessgott/tap/vkv
else
    go install github.com/FalcoSuessgott/vkv@latest
fi
{{- else }}
# For Linux systems, use go install
go install github.com/FalcoSuessgott/vkv@latest
{{- end }}
{{- else }}
echo "Skipping vkv installation - cloud group not enabled"
{{- end }} 